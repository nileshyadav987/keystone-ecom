"use strict";
var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __commonJS = (cb, mod) => function __require() {
  return mod || (0, cb[__getOwnPropNames(cb)[0]])((mod = { exports: {} }).exports, mod), mod.exports;
};
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
  mod
));
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// google-firebase-admin-key.json
var require_google_firebase_admin_key = __commonJS({
  "google-firebase-admin-key.json"(exports, module2) {
    module2.exports = {
      type: "service_account",
      project_id: "swapnalekhmarath-1585149573340",
      private_key_id: "3a9701db55b27d7592399819abf5888d43769971",
      private_key: "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCnXPd3ZUYTCWim\njCxEaiKWadvEfaiCVyNmyK2hXYq55QUHhBt8jRHHszc5TrTwnwfhFtN6JXd20gOl\n1drDUKPCr6wfeXminbRgp3YqYQRkTHGoBPh43f/VTbXxdJEE94hxYuYPp8C8E/x4\nRRh7+EgbQluoZso+DYO3nhtxoqbU5elHWVAbQYTx2qTHCAtsL5ERG7Vutomchrio\ntTp5dOQ0uhvC0OQjaq4ccXZNqXFIcLlOPJpPybQO/Sg2yVEN+AsSbm3n/WlWAb1F\nRy62jbIdeMNbO33NHDYgq1fGfAErgbiYkWXZKETxZciQzatKXeZdA1Sshl9LQ+ao\nXxEi3w6ZAgMBAAECggEALqLTOmv4CNn4VWB9/Vpt5Of+m1RAnoFVlhCZgXulaoOM\n0TlYx24v5CvmWYu7E8nc0jYgG8tQ7MU8yvs6iG5yE5AMMIETCeNUHhLL9KcwKBq9\nGQq5ikSiQ3fyGSRYPMAVPzNF1Fr0c/RFx+XJGtJmlWH6VITAGmZ9q67dCt8+CdjL\nscElAU58knCFND4zQsA3Y4ldAjxvp3Ehcq89eQR4ffXby7h3fwmyXFK8ouDVkigG\n4gapJRbFYujKzjA66fuFKIu6Rw5rnhGqCAxShJrsd7rx/7GFBxPWL/imn+iM/H9A\nDKzScNc6Pzcvz/YwZovQnpVXOpvwBDH4HRcD6IRIGQKBgQDUI8cJ6CxI0r/2LURb\nW09VwyZ5SG5SetYzQffalm6RUlXi1OfQAEbUgu+bh9rds/lSMg4G+zYqjjM9rxBW\n/TKtamYZ0coc+hTPX9+zhGJbVwcLJk0G/T9p9Sg68w6tdeQT1w91Hu5vCpDiSYrG\nK0Fypbk+cVuFzOt1n/CobP0biwKBgQDJ9zvwismttjuhN3MBjeW5jkNH0XrZvoOQ\n+6GWnDSljrngewOHJjxABCRlXJ83fqG5HZ5Bhhb3BIBEw/VLrSbVD/NuCZMBRVaY\nz05+LtAQyYlUePRXdX07XWe2dRF3oyogSP6+GTe+4KvsitthMzz8Yzyo+WCy24nd\nhNAS3qUS6wKBgF112bXCpOf8eXfyn4AELWKiVGvwfjI2TfJNKO4Tgmjhtlb1558a\n0BnGCdwisUklhj0xMj7fJBEBjw+o9fDtIguGqa7MX1f+0XY/TeXf+Bk3sTG3UQ44\nOlzrFitKc/f1zWL0R6oY04D2Tbh0IACIhBAHdSJOfLzo9/9dVIBPa/9bAoGANllV\nw/FVPG3htgyZ4j0xKLHj4Ru6F4ZxGT7dyQ3YDQVPd90ioefkJsX2lWBLaD+nfY0+\n3RscavTHH7or9GVwIb3dICtrZ9gk6ZI/6SznyNyzHAxAlJiFTshf9HWkcbFy0KVU\nCAv5OGB1Y34qcwm6y6BY3o/dOcRiYT4wUCOiAGkCgYEAk6a0myDTeNTOJ9Unqq8+\niIxOGbSL2gjSC89Pnre41Corl9+dNmwX3oZGA4q59yuRi9Mwcm2jzloCEHZUyohw\ncUySOgoBILJoJ03wDEZY7UMeg+TAWY0Apm2kGxbC5yMZcmf6g7gjw5TGVLqcr9FK\n/zCBxOea7se2/5+voqnB6f8=\n-----END PRIVATE KEY-----\n",
      client_email: "firebase-adminsdk-sl3xc@swapnalekhmarath-1585149573340.iam.gserviceaccount.com",
      client_id: "116636104324913351184",
      auth_uri: "https://accounts.google.com/o/oauth2/auth",
      token_uri: "https://oauth2.googleapis.com/token",
      auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
      client_x509_cert_url: "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-sl3xc%40swapnalekhmarath-1585149573340.iam.gserviceaccount.com"
    };
  }
});

// keystone.ts
var keystone_exports = {};
__export(keystone_exports, {
  default: () => keystone_default
});
module.exports = __toCommonJS(keystone_exports);
var import_core3 = require("@keystone-6/core");

// schema.ts
var import_core = require("@keystone-6/core");
var import_access = require("@keystone-6/core/access");
var import_fields = require("@keystone-6/core/fields");
var import_fields_document = require("@keystone-6/fields-document");
var import_cloudinary = require("@keystone-6/cloudinary");
var lists = {
  User: (0, import_core.list)({
    access: import_access.allowAll,
    fields: {
      name: (0, import_fields.text)({ validation: { isRequired: true } }),
      email: (0, import_fields.text)({
        validation: { isRequired: true },
        isIndexed: "unique"
      }),
      mobile: (0, import_fields.text)({
        validation: { isRequired: false },
        isIndexed: "unique",
        db: { isNullable: true }
      }),
      password: (0, import_fields.password)({ validation: { isRequired: true, length: { min: 1 } } }),
      posts: (0, import_fields.relationship)({ ref: "Post.author", many: true }),
      categories: (0, import_fields.relationship)({ ref: "Category.author", many: true }),
      products: (0, import_fields.relationship)({ ref: "Product.author", many: true }),
      createdAt: (0, import_fields.timestamp)({
        defaultValue: { kind: "now" }
      })
    }
  }),
  Post: (0, import_core.list)({
    access: import_access.allowAll,
    fields: {
      title: (0, import_fields.text)({ validation: { isRequired: true } }),
      content: (0, import_fields_document.document)({
        formatting: true,
        layouts: [
          [1, 1],
          [1, 1, 1],
          [2, 1],
          [1, 2],
          [1, 2, 1]
        ],
        links: true,
        dividers: true
      }),
      author: (0, import_fields.relationship)({
        ref: "User.posts",
        ui: {
          displayMode: "cards",
          cardFields: ["name", "email"],
          inlineEdit: { fields: ["name", "email"] },
          linkToItem: true,
          inlineConnect: true
        },
        many: false
      }),
      tags: (0, import_fields.relationship)({
        ref: "Tag.posts",
        many: true,
        ui: {
          displayMode: "cards",
          cardFields: ["name"],
          inlineEdit: { fields: ["name"] },
          linkToItem: true,
          inlineConnect: true,
          inlineCreate: { fields: ["name"] }
        }
      })
    }
  }),
  Category: (0, import_core.list)({
    access: import_access.allowAll,
    fields: {
      title: (0, import_fields.text)({ validation: { isRequired: true } }),
      author: (0, import_fields.relationship)({
        ref: "User.categories",
        ui: {
          displayMode: "cards",
          cardFields: ["name", "email"],
          inlineEdit: { fields: ["name", "email"] },
          linkToItem: true,
          inlineConnect: true
        },
        many: false
      }),
      products: (0, import_fields.relationship)({ ref: "Product.category", many: true })
    }
  }),
  Image: (0, import_core.list)({
    access: import_access.allowAll,
    fields: {
      attachment: (0, import_cloudinary.cloudinaryImage)({
        cloudinary: {
          cloudName: "dptwdk7ky",
          apiKey: "126874745125538",
          apiSecret: "QAtQFBs4zQIE_NKWsCHxsmgwpgo",
          folder: "shoprabbit-products"
        }
      })
    }
  }),
  Product: (0, import_core.list)({
    access: import_access.allowAll,
    fields: {
      title: (0, import_fields.text)({ validation: { isRequired: true } }),
      price: (0, import_fields.decimal)({ validation: { isRequired: true } }),
      source: (0, import_fields.text)({ validation: { isRequired: true } }),
      category: (0, import_fields.relationship)({
        ref: "Category.products",
        ui: {
          displayMode: "cards",
          cardFields: ["title"],
          inlineEdit: { fields: ["title"] },
          linkToItem: true,
          inlineConnect: true
        },
        many: false
      }),
      author: (0, import_fields.relationship)({
        ref: "User.products",
        ui: {
          displayMode: "cards",
          cardFields: ["name", "email"],
          inlineEdit: { fields: ["name", "email"] },
          linkToItem: true,
          inlineConnect: true
        },
        many: false
      }),
      photos: (0, import_fields.relationship)({
        ref: "Image",
        many: true
      })
    }
  }),
  Tag: (0, import_core.list)({
    access: import_access.allowAll,
    ui: {
      isHidden: true
    },
    fields: {
      name: (0, import_fields.text)(),
      posts: (0, import_fields.relationship)({ ref: "Post.tags", many: true })
    }
  })
};

// auth.ts
var import_crypto = require("crypto");
var import_auth = require("@keystone-6/auth");
var import_session = require("@keystone-6/core/session");
var sessionSecret = process.env.SESSION_SECRET;
if (!sessionSecret && process.env.NODE_ENV !== "production") {
  sessionSecret = (0, import_crypto.randomBytes)(32).toString("hex");
}
var { withAuth } = (0, import_auth.createAuth)({
  listKey: "User",
  identityField: "email",
  sessionData: "name createdAt",
  secretField: "password",
  initFirstItem: {
    fields: ["name", "email", "password"]
  }
});
var sessionMaxAge = 60 * 60 * 24 * 30;
var session = (0, import_session.statelessSessions)({
  maxAge: sessionMaxAge,
  secret: sessionSecret
});

// keystone.ts
var import_body_parser = __toESM(require("body-parser"));

// routes/categories.ts
async function listCategories(req, res) {
  const { context } = req;
  console.log("current user is ", res.locals.user);
  const data = await context.db.Category.findMany({
    where: {
      author: { id: { equals: res.locals.user } }
    }
  });
  res.json({ data });
}
async function addCategory(req, res) {
  try {
    const { context } = req;
    const input = req.body;
    const data = await context.db.Category.createOne({
      data: {
        title: input.title,
        author: { connect: { id: res.locals.user } }
      }
    });
    res.json({ data });
  } catch (e) {
    const message = e.message;
    res.json({ message });
  }
}

// routes/products.ts
var import_express_validator = require("express-validator");
async function listProducts(req, res) {
  const { context } = req;
  const data = await context.query.Product.findMany({
    query: `
            id
            title
            price
            source
            category {
                id
                title
            }
        `
  });
  res.json({ data });
}
async function addProduct(req, res) {
  try {
    const { context } = req;
    var errors = (0, import_express_validator.validationResult)(req);
    if (!errors.isEmpty()) {
      throw { message: errors.array()[0].msg };
    } else {
      const input = req.body;
      console.log(req.files);
      return res.json({ data: "nil" });
    }
  } catch (e) {
    console.error("rrr55", e);
    const message = e.message;
    return res.json({ message });
  }
}

// routes/users.ts
var import_firebase_admin = __toESM(require("firebase-admin"));
async function signin(req, res) {
  const { context } = req;
  const input = req.body;
  try {
    var data = await context.graphql.raw({
      variables: { identity: input.email, secret: input.password },
      query: `
        mutation ($identity: String!, $secret: String!) {
            authenticate: authenticateUserWithPassword(
            email: $identity
            password: $secret
            ) {
            ... on UserAuthenticationWithPasswordSuccess {
                item {
                id
                __typename
                name
                email
                mobile
                }
                __typename
            }
            ... on UserAuthenticationWithPasswordFailure {
                message
                __typename
            }
            __typename
            }
        }    
        `
    });
    if (data.data.authenticate.__typename === "UserAuthenticationWithPasswordSuccess") {
      console.log("ffo", data.data.authenticate.__typename);
      data = data.data.authenticate.item;
      const payload = {
        userInfo: data,
        createdAt: new Date().valueOf(),
        lastUsedAt: new Date().valueOf()
      };
      const fireData = await import_firebase_admin.default.firestore().collection("tokens").add(payload);
      const token = fireData._path.segments[1];
      res.json({ data, token: token + "/" + data.id });
    } else {
      throw { message: "Wrong email or password" };
    }
  } catch (e) {
    console.error("error==========", e);
    const message = e.message;
    res.status(400).json({ message });
  }
}
async function signup(req, res) {
  try {
    const { context } = req;
    const input = req.body;
    const user = await context.db.User.createOne({
      data: {
        name: input.name,
        email: input.email,
        password: input.password,
        mobile: input.mobile
      }
    });
    res.json({ data: { user } });
  } catch (e) {
    const message = e.message;
    if (message.toLocaleLowerCase().indexOf("email") > -1 && message.toLocaleLowerCase().indexOf("unique") > -1) {
      res.json({ message: "Email already exist" });
    } else {
      res.json({ message });
    }
  }
}

// test/@keystone-6/cloudinary/src/test-fixtures.skip.ts
var import_fs = __toESM(require("fs"));
var import_mime = __toESM(require("mime"));
var import_Upload = __toESM(require("graphql-upload/Upload.js"));
var import_cloudinary4 = __toESM(require("cloudinary"));

// test/@keystone-6/cloudinary/src/index.ts
var import_types = require("@keystone-6/core/types");
var import_core2 = require("@keystone-6/core");
var import_cuid = __toESM(require("cuid"));

// test/@keystone-6/cloudinary/src/cloudinary.ts
var import_cloudinary2 = __toESM(require("cloudinary"));

// test/@keystone-6/cloudinary/src/index.ts
var CloudinaryImageFormat = import_core2.graphql.inputObject({
  name: "CloudinaryImageFormat",
  description: "Mirrors the formatting options [Cloudinary provides](https://cloudinary.com/documentation/image_transformation_reference).\nAll options are strings as they ultimately end up in a URL.",
  fields: {
    prettyName: import_core2.graphql.arg({
      description: " Rewrites the filename to be this pretty string. Do not include `/` or `.`",
      type: import_core2.graphql.String
    }),
    width: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    height: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    crop: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    aspect_ratio: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    gravity: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    zoom: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    x: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    y: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    format: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    fetch_format: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    quality: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    radius: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    angle: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    effect: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    opacity: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    border: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    background: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    overlay: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    underlay: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    default_image: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    delay: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    color: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    color_space: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    dpr: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    page: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    density: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    flags: import_core2.graphql.arg({ type: import_core2.graphql.String }),
    transformation: import_core2.graphql.arg({ type: import_core2.graphql.String })
  }
});
var outputType = import_core2.graphql.object()({
  name: "CloudinaryImage_File",
  fields: {
    id: import_core2.graphql.field({ type: import_core2.graphql.ID }),
    filename: import_core2.graphql.field({ type: import_core2.graphql.String }),
    originalFilename: import_core2.graphql.field({ type: import_core2.graphql.String }),
    mimetype: import_core2.graphql.field({ type: import_core2.graphql.String }),
    encoding: import_core2.graphql.field({ type: import_core2.graphql.String }),
    publicUrl: import_core2.graphql.field({ type: import_core2.graphql.String }),
    publicUrlTransformed: import_core2.graphql.field({
      args: {
        transformation: import_core2.graphql.arg({ type: CloudinaryImageFormat })
      },
      type: import_core2.graphql.String,
      resolve(rootVal, args) {
        return rootVal.publicUrlTransformed(args);
      }
    })
  }
});

// test/@keystone-6/cloudinary/src/test-fixtures.skip.ts
var path = require("path");
import_cloudinary4.default.v2.config({
  cloud_name: process.env.CLOUDINARY_CLOUD_NAME || "cloudinary_cloud_name",
  api_key: process.env.CLOUDINARY_KEY || "cloudinary_key",
  api_secret: process.env.CLOUDINARY_SECRET || "cloudinary_secret"
});
var prepareFile = (_filePath) => {
  console.log("dd", __dirname);
  const filePath = path.resolve(`test/@keystone-6/cloudinary/src/test-files/${_filePath}`);
  const upload = new import_Upload.default();
  upload.resolve({
    createReadStream: () => import_fs.default.createReadStream(filePath),
    filename: path.basename(filePath),
    mimetype: import_mime.default.getType(filePath),
    encoding: "utf-8"
  });
  return upload;
};
var exampleValue = () => prepareFile("graphql.jpeg");
var exampleValue2 = () => prepareFile("keystone.jpeg");
var createReturnedValue = exampleValue().file.filename;
var updateReturnedValue = exampleValue2().file.filename;

// routes/images.ts
async function addImage(req, res) {
  try {
    const { context } = req;
    const data = await context.db.Image.createOne({
      data: {
        attachment: exampleValue()
      }
    });
    res.json({ data });
  } catch (e) {
    console.error("rrr55", e);
    const message = e.message;
    return res.json({ message });
  }
}

// keystone.ts
var import_firebase_admin3 = __toESM(require("firebase-admin"));

// library/middleware.ts
var import_firebase_admin2 = __toESM(require("firebase-admin"));
var validateToken = async (req, res, next) => {
  const token = req.headers["token"];
  try {
    if (token) {
      console.log("token here", token);
      const fireData = await import_firebase_admin2.default.firestore().collection("tokens").doc(token.split("/")[0]).get();
      const data = fireData.data();
      if (data === void 0) {
        throw "";
      } else {
        if (token.split("/")[1] === data.userInfo.id) {
          res.locals.user = data.userInfo.id;
          next();
        } else {
          throw "";
        }
      }
    } else {
      throw "";
    }
  } catch (e) {
    console.error("error", e);
    res.status(500).json({ message: "Token error" });
  }
};

// library/validate.ts
var import_express_validator2 = require("express-validator");
var newProduct = [
  (0, import_express_validator2.body)("category", "Category id is required").exists().not().isEmpty(),
  (0, import_express_validator2.body)("title", "Title is required").exists().not().isEmpty()
];

// keystone.ts
var serviceAccount = require_google_firebase_admin_key();
if (import_firebase_admin3.default.apps.length === 0) {
  import_firebase_admin3.default.initializeApp({
    credential: import_firebase_admin3.default.credential.cert(serviceAccount),
    databaseURL: "https://swapnalekhmarath-1585149573340.firebaseio.com"
  });
}
var keystone_default = withAuth(
  (0, import_core3.config)({
    server: {
      port: 3001,
      extendExpressApp: (app, commonContext) => {
        app.use(import_body_parser.default.json());
        app.use(import_body_parser.default.urlencoded({ extended: true }));
        app.use("/rest", async (req, res, next) => {
          req.context = await commonContext.withRequest(req, res);
          next();
        });
        app.get("/rest/category/list", validateToken, listCategories);
        app.post("/rest/category/new", [validateToken], addCategory);
        app.get("/rest/product/list", validateToken, listProducts);
        app.post("/rest/product/new", [validateToken, newProduct], addProduct);
        app.post("/rest/image/add", [], addImage);
        app.post("/rest/user/signin", signin);
        app.post("/rest/user/signup", signup);
      }
    },
    db: {
      provider: "postgresql",
      url: "postgres://postgres:123456@localhost:5432/shoprabbit"
    },
    lists,
    session
  })
);
// Annotate the CommonJS export names for ESM import in node:
0 && (module.exports = {});
